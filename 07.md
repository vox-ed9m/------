# Eduard Titkov WorkArea 

## Видео №12. DialPlan Приложения.

## Видео №8. Работа с конфигурационными файлами.

## Видео №9. Настройка SIP В Asterisk.

## Видео №10. Подключение Оператора К Asterisk.

все конфигурационные файлы хранятся в директории 
/etc/asterisk

Хорошей практикой является изучение стандартных конфигов, которые устанавливаются всей кучей перезатирая всё что есть коммандой `make samples` 

```
/etc/asterisk/modules.conf

**[modules]**

autoload=no    // Автоматически НЕ ЗАПУСКАТЬ ВСЕ модули, которые лежат в /usr/lib/asterisk
load=chan_sip.so  // Перечисляем, что запускать.
load=chan_iax.so
```
 

```
File: **/etc/asterisk/modules.conf**

[general]

autoload=yes    // Автоматически ЗАПУСКАТЬ ВСЕ модули, которые лежат в /usr/lib/asterisk
noload=chan_sip.so  // А эти исключить
noload=chan_iax.so
```


```
File: **/etc/asterisk/logger.conf**

[general]

[logfiles]
console => notice,warning,error,dtmf
full => notice,warning,error,debug,verbose,dtmf
```
/etc/asterisk/logger.conf Конфигурационный файл, который отвечает за то, чтобы астериск создавал логи. Здесь мы описываем какой полноты логи должны быть. - что должно попадать в наши логи, какие события должны быть в наших логах.

В console - мы работаем в консоль (-rvvv). В full - это файл /var/log/asterisk/full, куда будут поступать все события происходящие в системе.


```
File: **/etc/asterisk/sip.conf**
[general]
bindaddr=0.0.0.0  // мол слушать по любому интерфейсу порт 5060, чтобы работать по протоколу SIP
bindport=5060    
```
/etc/asterisk/sip.conf Параметры для подключения телефонов и операторов связи. Засчёт этого файла астериск будет инициализировать модуль SIP. !Протокол SIP не работает без протокола RTP


```
File: **/etc/asterisk/rtp.conf**
[general]
rtpstart=36600   // это порты, которые может использовать астериск для передачи голосовых соединений (RTP-соединений)
rtpend=39900
```
/etc/asterisk/rtp.conf  Протокол SIP не работает без протокола RTP

 
```
File: **/etc/asterisk/extensions.conf**

[general]

[globals]

[from-internal]
exten => 999,1,Playback(hello-world)
```
/etc/asterisk/extensions.conf Логические правила по обработке всех вызовов. -диалплан



Для того, чтобы изменения вступили в силу нужно сделать core reload либо core restart [now]. Так как на момент запуска астериска, этих конфигов не существовало - core reload'ом мы обойтись не сможем. service asterisk restart - ещё вариант.


--


// книга asterisk - будущее телефонии



```
File: /etc/asterisk/sip.conf

[general]
allow=alaw		// глобальное  указание кодеков 
allow=ulaw			
allow=gsm					
```









Обогощаем конфиг сервера абонентами
```
File: /etc/asterisk/sip.conf

[101]	//имя абонента (номер-абонента), чаще всего бывает именно цифровым, буквенными имена обычно  используются для подключения операторов связи, шлюзов. Для обычных телефонов - цифры.
host=dynamic		// адресс устройства по дхцп
type=user|friend|peer		// по отношению к серверу входящая связь, исходящая или двунаправленная.
context=from-internal		// полномочия устройства, которые мы хотим предоставить

**Это три миннимальных параметра, без которых устройство бы не заработало.**

И самое главное поле без которого нельзя начинать работу - это поле secret

secret=543698379t8yw45		// пароль, с помощью которого устройство будет подключаться к вашему серверу
```

```
File: /etc/asterisk/sip.conf

[101]
host=dynamic
type=friend
context=from-internal
secret=sdgsdlg;jsdlkgjlsd

dtmfmode=rfc2833		// rfc2833 - самый оптимальный протокол, обеспечивающий передачу нажатий клавиш на телефоне через сеть

qualify=yes				// телефон будет постоянно опрашиваться сервером. сервер будет постоянно пинговать ваш телефон, проверяя доступен ли он, работает ли он. Если в sip show peers светится статус Unmonitor, значим qualify выключен

disallow=all
allow=g722		// прописываем точечно кодек, но чтобы он не наследовал-тащил еще ворох кодеков прописанных мб в секции генерал -- добавляем сперва disallow all. g722 является HD-кодеком.

// !! ВАЖНО. прописываем сети, из которых разрешено подключаться абонентам
deny=0.0.0.0/0.0.0.0		// запрещаем подключение к данному номеру из любой сети 
permit=192.168.10.0/255.255.255.0		// та сеть, из которой работает ваш телефон
permit=10.0.0.0/255.255.255.0			// если работаем из нескольких сетей - несколько строк permit


nat=comedia  // если телефон который посылает нам на сервер находится за натом. https://asterisk-pbx.ru/wiki/artikle/nat
callgroup=329  // в какой группе (в каком кабинете) находится абонент
pickupgroup=329 // звонки каких групп (каких абонентов) он может перехватывать.
directrtpsetup=no // запрещаем rtp трафик ходить кроме как через сервер, чтобы держать архитектуру соединений статичной
directmedia=no // запрещаем rtp трафик ходить кроме как через сервер
```

ps1
```
грубо
[user1]
callgroup=1
pickupgroup=2

[user2]
callgroup=2
pickupgroup=1

[user3]
callgroup=3
pickupgroup=1,2

user1 может перехватить звонок, идущий на user2
user2 -- // -- user1
user3 -- // -- user1 и user2
```

ps2
```
Мы можем создать шаблон. И наследовать его пользователем. Как выглядит:

[general]
...
...

[office](!)
host=
nat=
calllimit=2  // разрешаем пользователям этого шаблона совершать не более 2х исходящих одновременно вызовов 
...

[201](office)
callerid=Alexey Petrov <201>
secret=dflhjd;fdh // отдельный параметр, или параметр перекрывающий унаследованный дефолт (шаблонный)
```



> После обновления конфига делать `sip reload`

$ sip show peers 	// показывает все устройства которые есть в системе 

$ sip show peer 101  // вывести точечную информацию


#### На телефонах прописывается (на каждую линию)

![Imgur](https://imgur.com/qjbRZuT.png )

proxy  - это айпи адресс сервера куда я подключаюсь, айпишник астериска

register - возможно регистрации? - непонял. звонок без регистрации это как. А. Без регистрации на сервере, видимо. Без уведомления.

Register Expires - время жизни. для телефонов за натом нужно делать маленькое. типа 180

https://docs.telcobridges.com/tbwiki/SIP_Registration


display name && user id	- это логин с которым я подключаюсь.

password - это пароль с которым я подключаюсь

--

Sip-порт рекомендуется менять по какому-либо принципу. Для своего сип-протокола телефон использует порт. По порту можно обнаружить телефон в сети, сканируя её. + это улучшает прохождение NAT'a. - чтобы не ддосить порт.!!

Message Waiting - это голосовая почта.

Default Ring - мелодия звонка

Телефон ребутается 2-3 минуты.


> При регистрации абонента, в консоль астериска идёт уведомление. (при должном количестве v, надо полагать?)

#### Подключение к серверу оператора связи - это и называется транк. 

Первое что нужно понимать, что подключение оператора связи в плане настроек подключения ничем не отличается от подключения обычного телефона. Для Астериска в плане настроек нет разницы является ли устройство телефоном или оператором связи, однако некоторые операторы требуеют определенные специфические параметры.

Точно так же наш сервер может выступать, как бы условно говоря, "телефоном" для оператора связи. Потому как к оператору связи точно так же может быть подключен телефонный аппарат, который точно так же будет с ним работать.

Например оператор связи msm.

Транк, соответственно, создаётся конфигурацией в sip.conf - не так страшен чёрт. 


**Регистрация.**

Регистрация - это уведомительный процесс. Регистрация служит для того, чтобы сервер знал телефон. Например, у нас динамический айпи-адресс - и поэтому ___ 

Наш сервер, имея подключение к оператору связи точно так же проходит регистрацию. Без регистрации оператор связи просто не знал бы где мы есть, входящие через этого оператора были бы впринципе не возможн

Регистрация прописывается строкой, идущей после глобальных параметров. 

```
[general]
...
...
...

;register => login:pass@ip-operatora/DID-nomer

;;;;;; MSM
register => 1044077:528091207@sip.ipport.net/7499579912


```

```
[general]
...

[msm]
host=sip.ipport.com
fromdomain=sip.support.net
defaultuser=1044077    ;; это наш логин, который присвоен нам оператором связи
fromuser= 1044077    ;; это наш логин, который присвоен нам оператором связи
secret=fglhkjdflkhjlk

type=friend     ;; и оператор будет направлять звонки к нам, и мы будем направлять звонки оператору
context=from-trunk   ; часть диалплана, где будет обрабатываться звонок, поступающий от оператора
dtmfmode=rfc2833	
qualify=yes	
disallow=all
allow=~~g722~~      ;;  HD-кодеки НЕ ПОДДЕРЖИВАЮТСЯ операторами связи. g722 -HD
allow=alaw
allow=ulaw


insecure=invite,port    ;; port - не требовать совпадения порта в инвайте
                          ;; invite - не требовать аутентификации в инвайте
```

![Imgur](https://imgur.com/PGs9qvS.png)
DID - сам номер, на который мы будем получать звонки от клиентов, SIP-ID - это логин.

// DID-nomer - это очень важное понятие, важная сущность.

Если в строке регистрации будет не логин:пароль@хост/номер
а логин:пароль@хост
то входящие вызовы тоже будут приходить, но не на конктерное правило с did номером 8495.... , а на экстеншен 's'
(и если не будет маршрута (во freepbx did - any) - не пройдут)

![Imgur](https://imgur.com/SGM25Re.png)
Есть Астериск, есть абонент 101, есть абонент 102. Когда абонент 101 посылает вызов, чтобы дозвониться до абонента 102 -- _Астериск принимает инвайт_, где написано: вызывается 102! -- И Астериск дальше думает, а как же мне этого 102 найти.  


Когда ваша станция(сервер) подключена к оператору связи, в вашем взаимодействии тоже есть место некоторым инвайтам. Вот этот номер, который будет вызываться - 102 - его можно иначе назвать ожидаемый обратный номер.. Мы можем попросить оператора - засчёт указания строки регистрации - что мол давайте когда к нам приходит звонок из города, вы нам в инвайте присылайте вот этот наш номер: 84995799112
![Imgur](https://imgur.com/iugwC3N.png)

и тогда, когда вызов приходит к нам из города, на нашей станции вызывается этот номер и дальше на нашей станции буду запускаться те правила обработки вызова, которые связаны с этим номером. 

Говорит, что регистрацию можно прописывать в профиле абонента. 
```
[general]
...

[msm]
host=
fromdomain=
defaultuser=
fromuser=
secret=
....
callbackextension=84995799112ыы
```
 и это мол равнозначно. Ну да, там же всё остальное прописано по сути уже. host,login,password
 
 делаем sip reload и видим, что Астерисковый транк стал доступен.   -- засчёт qualify это всё, собственно. 
 ![Imgur](https://imgur.com/uV9fv5I.png)

Чтобы понять, прошла регистрация или нет - `sip show registry`

Для диагностики, чтобы проверить, будет ли работать связть, будут ли входящие звонки - можем запустить `sip set debug peer msm` и позвонить на наш номер, чтобы посмотреть приходят ли вообще инвайты [в консоль посыпется довольно-таки много информации]

-- там мы увидим, что звонок был отклонен, по причине того что мы прописали левый контекст диалплана. т.е. **связь между нами и оператором** есть, **вызовы** к нам **поступают**, но пока что они **обработаться** никак **не могут.**

Важно понимать, что даже если связь между оператором и нами установлена, вызовы поступают, но логика не прописана - то этого мало мол. 

> sip set debug off
