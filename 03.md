# Eduard Titkov WorkArea 

## Видео №19. IP-ATC Asterisk. Безопасность.

**УСТАНАВЛИВАЙТЕ ASTERISK ТОЛЬКО ТОГДА, КОГДА УВЕРЕНЫ В ВОЗМОЖНОСТИ ОБЕСПЕЧИТЬ ЕГО БЕЗОПАСНОСТЬ.**

## Взлом VoIP - один из самых удобных способов монетизации хакера.**

Взлом Сервера Астериск - это ключ ко всему.

**Это могут делать в контексте наживы,**

**это могут делать в контексте конкурентной разведки,**

**это могут делать в контексте формирования ботнетов, захват сервера т.п.**





 **терминация траффика, межоператорские договоры.**
>
>_У операторов телефонии есть такое понятие как терминация. Межоператорские договоры_
>
>_Допустим вы оператор мтт, я оператор мтс. У вас есть свой абонент, у меня есть свой._
>
>_Если ваш абонент звонит моему абоненту, то вы со своего абонента берёте деньги за инициацию траффика, но в тоже время чтобы ваш вызов мог пройти в мою сеть, вы тоже должны мне заплатить какую-то условную сумму денег -- это у операторов называется терминацией траффика_
>
>_Получается, что когда я буду звонить вашему абоненту, то я возьму каких-то денег со своего[абонента], и заплачу каких-то денег вам._
>

**схема слива**

Есть операторы, которые предоставляют премиальные номера, т.е. номера стоимость звонков на которые сильно отличается от среднерыночных

Многие операторы из стран третьего мира [Куба, Венесуэлла, Никарагуа, Сомали, Литва, таких стран много] имеют на своей территории операторов, которые возможно даже не имеют своих абонентов, т.е. существуют именно для того, чтобы взломанная АТС совершила звонок так, чтобы оператор взял денег с остальных операторов, через которые этот вызов поступил

![.](https://i.imgur.com/xEimCdU.png)

* Вот посмотрите на данную схему. В этой схеме видим целый контур, и ключевое звено здесь некий оператор, который находится на кубе, и который предоставляет некий  номер +1(222)12341243123

* Есть хакер, который решил подзаработать денег. С помощью несложных действий находит wape-биржу, биржу сливного трафика, и проходит на этой бирже регистрацию. И получив свой личный кабинет хакер видит непкий перечень телефоных номеров. Если на эти номера поступает вызов, то так или иначе тот кто этот выцов инициировал заплатит деньги всем операторам, через которых этот вызов прошёл.

> Т.о., оператор, который готов таким образом зарабатывать, выдаёт пул своих номеров на биржу сливного трафика.

* Злоумышленнику, получившему эти номера остаётся лишь решить одну проблему - это найти какие-то телефонные устройства, какие-то аппараты, через которые можно совершать такие вот звонки. -- это может быть ssh-доступ к серверу, это могут быть креды к веб-морде, это может быть просто украденный сип-аккаунт. И дальше, уже пользуясь своим доступом, он загружает его скриптом, инициируя совершать звонки на те номера, которые он получил на бирже. То есть он сливает траф. Но надо заметить что монетизация за этот трафф копеечная, поэтому он будет сливать всё и во все каналы, тем самым нанося могущественный урон бизнесу. - Реальных разговоров вы там не услышите, это будут какие-то записанные роботом фразы и т.п. Т.е компания, допустим, внедрила себе ip-телефонию, и вследствии халатного отношения к безопасности понесла миллионые убытки (образно).


---


Безопасность - это не какая-то галочка, это комплекст мер, который сосредоточен не столько в самом астериске, а в том что его окружает, и потому очень важно понимать как работает сама телефония, чтобы чувствовать места, в которых телефония может быть потенциально уязвима. В любом случае, когда вы думаете про безопасность, нужно учитывать ровно всё-всё-всё что может вас вообще касаться.


Защиту нужно строить не только на физических уровнях, но и на логических. Потому что даже простые приемы, условно говоря запрет на звонки в нерабочее время может просто разрушить все планы злоумышленника, которые обычно именно в выходные дни производят свои атаки.

Чтобы Астериск не только работал, а работал только для вас - нужно пройти определенный комплекс мер, процедур, чтобы обеспечить его защиту.

![.](https://i.imgur.com/1GDiUiu.png)





> В дистрибутиве TrixBox существует дефолтная учётная запись wwwadmin с паролем passw0rd

> Рекомендуется замещать TrickBox системой FreePBX


---


# IP-АТС Asterisk: Безопасность

Типовые грубые security-ошибки.

* Слабые пароли на внутренних номерах.
* Отсуствтие контроля за системой.
* Отсутствие Firewall

> Хорошей практикой является обновлять логин со стандартного _admin_ на что-то более уникальное, для воспрепятствования брута пароля на номерах.

# **Построение безопасности Астериске строится сразу на нескольких уровнях.**

## Административные меры

* Запрет международной связи на уровне оператора. // многие клиенты впринципе не горят желаением пользоваться международной связи, пользуются внутренним рынком.

//Можно идти дальше и прививать такую культуру, когда: отключив международную связь у основного оператора подбирается другой оператор, у которого работает предоплатная система оплаты звонков. Условно говоря, подключив sipnet и положив на лицевой счёт 10к рублей, компания будет целый год расходовать их, при нечастом юзании. По деньгам тоже может быть всё много лучше.

* Ограничение по IP на транк.

> Магистральный порт или Trunk port — это канал типа «точка-точка» между коммутатором и другим сетевым устройством. Магистральные подключения служат для передачи трафика нескольких VLAN через один канал и обеспечивают им доступ ко всей сети. Магистральные порты необходимы для передачи трафика нескольких VLAN между устройствами при соединении двух коммутаторов, коммутатора и маршрутизатора или коммутатора и сетевого адаптера узла с поддержкой транкинга 802.1Q.

Подключив trunk от оператора связи, вы должны сказать ему, что мы с этим транком можем пользоваться лишь с вот этих вот ip-адрессов и перечислить ему те ip-адреса, которые за вашей компанией закреплены. То есть, просто чтобы не оказалось, что используя ваш логин и пароль, с которыми вы подключаетесь к оператору, какой-то злоумышленник просто иногда звонит за ваш счёт.

такая вот простая мера, просто письмо: _Информируем Вас, что наша компания использует такие-то адреса, просим запретить возможность звонить с других ip-адресов._

* Ограничение на сумму счёта или авансовая оплата
Договоритесь с оператором о максимальной стоимости по счёту или перейдите на авансовую оплату -- часто у операторов нет лимита.

* Защита рабочих станций с софтонами

* Смена паролей при смене админа

Если вы пришли на место системного администратора, который ушёл из компании - обязательно поменяйте те пароли, которые могли бы использоваться администратором ушедшим из-за пределов компании.

## Сетевая защита (IPTables)

IPTables - лучший фаервол в мире, который был изобретен.

## Дизайн сети (VLAN + VPN) -- как астериск встроен в инфраструктуру компании. Используются ли VLAN'ы, используются ли VPN?

V=Virtual. Первоначально Vlan'ы появились для того, чтобы с помощью программных средств изолировать определённые части сети друг от друга. Например, чтобы изолировать сеть сотрудников от сети бухгалтерии. -- физически, с той же целью вы могли бы посадить бухгалтеров на отдельный свитч.

> Взяв два железных коммутатора и соединив их между собой патч-кордом, настроив порты в которые этот патчкорд подключен в специальном транковом режиме, вы можете сделать так, что условно влан для бухгалтерии на одном коммутаторе и влан для бухгалтерии на другом коммутаторе, образуют один единый коммутатор, который работает как бы физически на разных устройствах, но в то же время он изолирован от других портов.

В вашей компьютерной сети телефонная сеть, по-хорошему, должна быть изолирована от всех прочих сетевых устройств.

В вашей компьютерной сети должна существовать виртуальная сеть для телефонных аппаратов, для вейп-шлюзов, для астериска,и должна существовать отдельная сеть, которая с основной никак не связанна никак не пересекается. -- дело в том, что системные администраторы всегда считают, что если сервис расположен в локальной сети и не опубликован в интернет, то уделять должного времени и должного внимания его безопасности не обязательно. 

другая проблема может быть сосредоточена в самих ваших пользователях, которые тоже могут из каких-то соображений захотеть модифицировать информацию на сервере, захотеть подключиться к нему с более высокими привилегиями нежели чем это необходимо на самом деле.

Сейчас в телефонных аппаратах используются умные коммутаторы, которые позволяют вам разделить трафик на трафик для телефона и трафик для самого пользователя. -- и эти трафики вообще не смешиваются между собой, потому что они протегированы разными метками. И условно говоря, если вы с компьютера пингуете телефон, которые находится на расстоянии одного патч-корда, то трафик с компьютера не достигнет телефонного аппарата, потому что телефонный аппарат пропустит его насквозь и пустит дальше, и если потом дальше трафик не вернётся, то впринципе он уже никак не сможет на телефон попасть. (а вернуться он сможет лишь в том случае, если vlan сеть данных и vlan сеть телефонии связаны между собой с помощью устройства 3-го уровня, то есть маршрутизатора, который на себе имеет firewall.[далее,благодаря iptables трафик можно разделить трафик который вы хотите пропускать и тот, который нужно заблокировать. в этой точке у вас появляется гибкость - вы сами решаете какой трафик может зайти в сеть телефонии, а какой нет])

Сеть, состоящая всё еще из одного коммутатора, но 5 вланов
![сеть, состоящая из 5 вланов](https://i.imgur.com/rWWlArL.png)
На самом деле этих коммутаторов может быть здесь не 1 а 20, количество портов не 24 а 1000 - это не имеет никакого решительного значения, суть совершенно не изменится.

У нас каждый пользователь имеет своё собственной рабочее место и это рабочее место подключено в телефон, а телефон уже подключен в свитч. Для пользователей мы создали влан10, для телефонов мы создали влан20 и трафик приходящий на коммутатор уже разбирается в зависимости от того с каким тегом он пришёл.

Сам астериск мы можем подключить одним всего проводом. На уровне ядра существует возможность создавать несколько виртуальных карт. То есть вы можете с помощью технологии транкования подключить общим шнурком свой астериск и на нём создать несколько разных интерфейсов, каждый из которых будет работать со своим собственным вланом, каждый из которых будет иметь свой собственный ип-адрес. 

Далее вы можете используя коммутатор подключить и другие сети. Например, vlan c номером 100 - это оператор ip-телефонии предоставил услушу sip-телефонии, используя выделеныый кабель. И нередко бывает что у вас в сервере лишь один сетевой интерфейс, который вы уже задействовали, для подключения к локальной сети. И получается, что завести этот провод себе, вы можете лишь используя технологию влан. Linux это поддерживает очень хорошо.

Так же мы на свой астериск подали внешний ip-адрес, за счет того, что от провайдера подключили на свитч выделенный провод

**VPN**

Первым делом шифрует трафик. 

Телефонный трафик легко перехватить и прослушать.

Чтобы не заморачиваться шифрованием реализованным в самом протоколе SIP (настраивая каждый телефон), предлагается шифровать весь трафик используя VPN-туннель. -- ну что-то в этом есть.

Кроме того нет необходимости публиковать сервер sip-телефонии на внешнем ip-адрессе, что несомненно повышает защищённость системы.

Лучше строить свою сеть правильно, чтобы у вас все коммуникации, между двумя сотрудниками, проходила через шифрованные туннели.


## Анализатор логов (Fail2Ban) -- в системе необходимо постоянно отслеживать какие-то попытки злонамеренной активности

```
$ service fail2ban [start|stop|restart]
```

..* работает на уровне iptables
..* оперирует последним диапазоном времени [например в последние 10 минут]
..* настраивается под каждый сервис [аля мониторить апач, ссщ etc]. имеет флаг активации true|false

примерный конфиг
```
[asterisk-iptables]
enabled = true
filter  = asterisk
action  = iptables-allports[name=SIP, protocol=all]
          sendmail-whois[name=SIP, dest=log@voxlink.ru, sender=fail2ban@voxlink.ru]
logpath = /var/log/asterisk/fail2ban
maxretry  = 5
bantime = 86400
```

**filter** - это определенный файл, есть определенная папка в структуре конфигов fail2ban'а и в этой папке есть файл астериск, и вот в том файле описаны регулярные выражения, согласно которым мы как раз и парсим файл с логами.

**action** - это что нужно сделать когда кто-то попался . iptables-allports, означает что нужно запустить скрипт iptables-allports [из навзвания понятно, что это происходит блокировка по всем портам злолумышленника ]. вторым скриптом мы отправляем письмо-вхуиз, с выясненной информацией о злоумышленнике.

**logpath** - какой лог файл должен читать fail2ban, чтобы собственно искать попытки злоумышленника получить авторизацию.

**maxretry и bantime** - для каждой ловушки можно переопределить.


Правила фильтрации можно прописать в файле /etc/fail2ban/filter.d/asterisk.conf. Вот образец содержимого этого файла:

```

# Fail2Ban configuration file
#
#
# $Revision: 250 $
#

[INCLUDES]

# Read common prefixes. If any customizations available -- read them from
# common.local
#before = common.conf


[Definition]

#_daemon = asterisk

# Option:  failregex
# Notes.:  regex to match the password failures messages in the logfile. The
#          host must be matched by a group named "host". The tag "<HOST>" can
#          be used for standard IP/hostname matching and is only an alias for
#          (?:::f{4,6}:)?(?P<host>\S+)
# Values:  TEXT
#

# Asterisk 1.8 uses Host:Port format which is reflected here

failregex = NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - Wrong password
            NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - No matching peer found
            NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - Username/auth name mismatch
            NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - Device does not match ACL
            NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - Not a local domain
            NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - Peer is not supposed to register
            NOTICE.* .*: Registration from '.*' failed for '<HOST>:.*' - ACL error (permit/deny)
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - Wrong password
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - No matching peer found
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - Username/auth name mismatch
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - Device does not match ACL
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - Not a local domain
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - Peer is not supposed to register
            NOTICE.* .*: Registration from '.*' failed for '<HOST>' - ACL error (permit/deny)
            NOTICE.* .*: Registration from '\".*\".*' failed for '<HOST>:.*' - No matching peer found
            NOTICE.* .*: Registration from '\".*\".*' failed for '<HOST>:.*' - Wrong password
            NOTICE.* .*: No registration for peer '.*' \(from <HOST>\)
            NOTICE.* .*: Host <HOST> failed MD5 authentication for '.*' (.*)
            NOTICE.* .*: Failed to authenticate user .*@<HOST>.*
            NOTICE.* <HOST> failed to authenticate as '.*'$
            NOTICE.* .*: Sending fake auth rejection for device .*\<sip:.*\@<HOST>\>;tag=.*
            NOTICE.* .*: <HOST> tried  to authenticate with nonexistent user '.*'
            VERBOSE.*SIP/<HOST>-.*Received incoming SIP connection from unknown peer

# Option:  ignoreregex
# Notes.:  regex to ignore. If this regex matches, the line is ignored.
# Values:  TEXT
#
ignoreregex =
```

Для asterisk версии 10 и выше, если Вы включили ведение логов security, не забудьте прописать правила фильтрации для этих логов!

Правила фильтрации можно прописать в файле /etc/fail2ban/filter.d/asterisk-security.conf. Вот образец содержимого этого файла:


```
# Fail2Ban configuration file
#
#
# $Revision: 250 $
#

[INCLUDES]

# Read common prefixes. If any customizations available -- read them from
# common.local
#before = common.conf


[Definition]

#_daemon = asterisk

# Option:  failregex
# Notes.:  regex to match the password failures messages in the logfile. The
#          host must be matched by a group named "host". The tag "<HOST>" can
#          be used for standard IP/hostname matching and is only an alias for
#          (?:::f{4,6}:)?(?P<host>\S+)
# Values:  TEXT
#

failregex = SECURITY.* SecurityEvent="FailedACL".*RemoteAddress=".+?/.+?/<HOST>/.+?".*
            SECURITY.* SecurityEvent="InvalidAccountID".*RemoteAddress=".+?/.+?/<HOST>/.+?".*
            SECURITY.* SecurityEvent="ChallengeResponseFailed".*RemoteAddress=".+?/.+?/<HOST>/.+?".*
            SECURITY.* SecurityEvent="InvalidPassword".*RemoteAddress=".+?/.+?/<HOST>/.+?".*

# Option:  ignoreregex
# Notes.:  regex to ignore. If this regex matches, the line is ignored.
# Values:  TEXT
#
ignoreregex =
```

> iptables -L //проверить цепочки


Что вообще может привести к атаке, если ещё на подлёте с помощью ip-tables можно резать практически всё?


## Конфигурация Linux -- правильным образом сконфигурирова, отключая лишние модули , лишние компоненты, обеспечив защиту по  ssh, административную защиту.

### Отключение лишних служб

// https://www.opennet.ru/base/sys/run_services_tips.txt.html

```
chkconfig --list

chkconfig someservice off
```


### SSH по сертификатам

ssh-keygen -t dsa
```
sshd.conf

RSAAutentication              yes
PubkeyAutentication           yes
PasswordAutentication         no
```

Скопировать открытый ключ на сервер
ssh-copy-id -i /root/.ssh/id_dsa root@192.168.10.1




### Ограничение доступа к Apache

```
ServerSignature Off           //Отключение фингерпринта
ServerTokens Prod             //Отключение фингерпринта

<Directory>         
Order Deny,Allow
Deny from all
Allow from 192.168.10.0/24    //Доступ только с разрешенных сетей
</Directory>
```




## Конфигурация Asterisk -- обеспечить защиту самого астериска, отключением лишних компонентов, которые у вас не используются, использование последних версий софта, не содержаться ли в вашей версии уязвимость и  т.д.


### Обновление Asterisk

Беспроблемное обновление - только **в пределах одной мажорной версии (1.8 -> 1.10 -> 1.11)

Обновляем только в том случае, если новая версия решает проблемы безопасности, которые можно использовать в вашей конфигурации.

Ну и юзать lts-варианты.

### Asterisk Manager Interface

опасная штука, если попала в руки злоумышленнику.

штука, которая даёт какую-то потрясающую гибкость в плане разработки какого-то стороннего приложения, которое может управлять Астериском, иниицировать звонки, но в то же время это и большая опасность.

Контроль учётных записей и ACL в /etc/asterisk/manager.conf

убедиться, что 

* имеют сложные длинные пароли

* имеют привязку к тем сетям, откуда этими учётными записями можно пользоваться

* имеют не полные привелегии, а только лишь те, которые реально нужны для данной учётной записи AMI.


### sip.conf

Астериск по умолчанию светит портом 5060 и очень быстро становится объектом интереса, объектом брут-форс атаки.


```
/etc/astersik/sip.conf

[general]
bindport  =  6050       
```

_момент в том, что этот же порт прописывается на телефонах_
поэтому лучше форвардить iptables'ом, во избежании недопониманий. -- открыть какой-нибудь порт и сделать так, чтобы с него шло перенаправление на порт 5060, а сам 5060 закрыть снаружи.

> Для интереса можно опубликовать на внешнем ip-адресе астериск, к которому даже не будет ничего подключено, и буквально через несколько часов пойдёт атака.



```
[general]
alwaysauthreject=yes         //сообщение 401 Unauthorized; защита от харвест-атаки, когда пробивается существует ли логин впринципе или нет.       
```


```
/etc/astersik/sip.conf

[general]
allowguest=no //запрещаем гостевые SIP-соединения
```


```
/etc/astersik/sip.conf

[101]
deny=0.0.0.0/0.0.0.0
permit=192.168.0.0/255.255.255.0        //важно прописать сети, доступ из которых разрешен
secret=nvidfgkajerhbvt34512             //чтобы даже при утечке пароля, существовали логические элементы безопасности. Секрет генерить длиной 30 символов, спецсимволы, если настраивается в ручную.
```

```
/etc/astersik/sip.conf

[101]
call-limit=2        //для пользователя совершать более двух одновременных звонков как правило не нужно, а нам мера безопасности при варианте взлома.

context=from-closed //используем различные контексты
```


По умолчанию, заставляется вашу sip-станцию представляться полностью. Для сокрытия фингерпринтов:
```
/etc/asterisk/sip_general_custom.conf

useragent=ChuckNorrisPBX
realm=ChuckNorrisPBX
sdpsession=ChuckNorrisPBX
```

### Отключение лишних модулей Asterisk

Отключение лишних модулей Asterisk
Выбираем заведомо ненужные модули и отключаем их в конфигурационном файле
// http://www.asteriskdocs.org/en/3rd_Edition/asterisk-book-html-chunk/asterisk-CHP-5-SECT-1.html

Пример того, какие модули отключают.
```
/etc/asterisk/modules.conf

noload = app_directory_odbcstorage.so   // ???
noload = app_voicemail_odbcstorage.so   // ???
noload = chan_sccp.so                   // ???
noload = chan_skinny.so                 //Cisco Skinny Client Control Protocol (SCCP) channel driver
noload = chan_bridge.so                 //Used internally by the ConfBridge() application; should not be used directly
noload = chan_mgcp.so                   //Media Gateway Control Protocol channel driver
noload = chan_gtalk.so                  //Provides connection to Google Talk
noload = chan_multicast_rtp.so          //Provides connection to multicast RTP streams
noload = chan_unistim.so                //Nortel Unistim protocol channel driver
noload = chan_jingle.so                 //Provides connection to Jingle-enabled endpoints
noload = chan_mobile.so                 // ???
```

### Защита диалпланом [Диалплан Asterisk.] 


//Сотруднику нужно давать именно те права, которые ему требуются, все остальные права нужно забирать.Нет смысла давать сотруднику право звонить на международные линии, на Кубу, Вьетнам, если его работа не связана со звонками во Вьетнам.


> В варианте, когда абонент подключается с внешних динамических ip в целях противодействия логичнее всего обрезать ему возможность совершать международные звонки. Если же международная связь нужна - вешать на звонок pin-код. Ко всему прочему, их вроде как еше проблематично брутить. Шестизначный вон.


**Разделение абонентов на контексты.**
```
[101]
context=from-it
[102]
context=from-buch
[103]
context=from-boss
```

**Пример защита с помощью диалплана в extensions.conf (запреты вызовов)**
```
[allow-all]
exten=>_X.,1,Dial(SIP/operator/${EXTE
N})
exten=>_10X.,1,Dial(SIP/${EXTEN})
[from-it]
exten=>_810.,1,Hangup()
exten=>_.,1,GoTo(allow-all,${EXTEN},1)
[from-buch]
exten=>_810.,1,Hangup()
exten=>_89.,1,Hangup()
exten=>_.,1,GoTo(allow-all,${EXTEN},1)
[from-boss]
exten=>_.,1,GoTo(allow-all,${EXTEN},1)
```

**Пример информирования о попытках звонков на 810. ** 

По количеству информирований - например вам стали приходит сотни таких уведомлений - можно сообразить, что станция была взломана и злоумышленники пытаются прозвонить на международные направления тот аккаунт, что был взломан.
```
exten => _810.,Playback(zapret-zvonkov)
same => n,System(echo ${EXTEN}> mail -s "8-10 ALARM!!!" admin@ya.ru)
same => n,Hangup()
```
Самое интересное здесь то, что вы сами узнали о взломе, благодаря тому поведению, что настроили.




// В рабочее время проще заметить, что всё как-то загружено-перегруженно-ведёт себя странно, поэтому атаки нередко делают в выходное время суток. -- отсюда решение ограничивать звонки по времени.
**Ограничение на право международных звонков по времени**
```
GotoIfTime(9:00-18:00|mon-fri|*|*?menu1,s,1)

[from-it]
exten=>_810.,1,GoTo(mail-info,${EXTEN},1)
exten=>_.,1,GotoIfTime(9:00-18:00|mon-fri|*|*?allow-all,${EXTEN},1)
exten=>_.,n, Playback(zapret-zvonkov)

[mail-info]
exten => _X..,Playback(zapret-zvonkov)
same => n,System(echo ${EXTEN}> mail -s "8-10 ALARM!!!" admin@ya.ru)
same => n,Hangup()

[allow-all]
exten=>_X.,1,Dial(SIP/operator/${EXTEN})
exten=>_10X.,1,Dial(SIP/${EXTEN})
```

Во FreePBX есть такое понятие как маршруты. А в исходящих маршрутах есть такое понятие, как временная группа, где вы указываете диапазон вами созданный, и это будет то время, когда это правило этот маршрут  будет работать. В любое другое время этот маршрут будет проскакивать как неактивный.




## Защита периферийных устройств -- ip-телефония - это астериск и все оборудование к нему подключенное. обеспечить безопасностью ваши voip-шлюзы, ваши ip-телефоны -- а за ними тоже нужен глаз да глаз.


> Размещать оборудование на внешних айпишниках не реккомендуется, но даже если вам нужно разместить на внешних айпишниках - вы можете поставить файрвол.

> На 95% изделий есть веб-интерфейс. Идеально, когда стоит сложный пароль, а сам интерфейс отключен. Если нужно - он поднимается парой кликов из телефона.

Всё голосовое оборудование нужно помещать в голосовой vlan, с которым нет связи с другими устройствами, с другими сетями.

На телефонах и шлюзах рекомендуется менять порт SIP 5060. Это повышает устойчивость к сканированиям.

??? - Разносят все сип-порты, делая их на всех устройствах разными. Типа номер 101 - делаем ему сервисный порт 50101, номер 102 - 50102. Помогает с проблемой ната и unreachable.

voip-шлюз
voip-шлюз, в который у вас подключены с одной стороны астериск, с другой аналаговые линии/потое е1; на сам шлюз происходит атака, которая дальше позволяет злоумышленнику звонить на городские линии, и в астериск вообще ничего не пойдёт, он ничего не узнает об этой активности. Такое может произойти если сам шлюз находился не в влан, ни ещё где-то, а он был либо был на внешнем айпишнике, либо на него был проброшен порт 5060

ip-телефоны

какие-то другие voip-девайсы, имеющие свои собственные прошивки



