# Eduard Titkov WorkArea 

## Гарольд-Lite. Системная Настройка. Quiz

## Видео №7. Работа В Консоли Asterisk.

## Видео №11. DialPlan. Введение.


---


**Для выполнения nix-комманды** из консоли астериск нужно добавить !, т.е, например, !ifconfig

**Для выполнения asterisk-комманды** из консоли линукса: $ asterisk -rx 'core show channels'


---


Для того, чтобы попасть в консоль мы пишем asterisk -rvvv
-r подключение к уже запущенному процессу
vvv (verbose) - логгирование. больше v = больше глубина логгирования 

После изменения конфигов: $ sip reload / $ dialplan reload / iax reload / something_module reload

Модули загружаются и выгружаются $ module load ___ , $ module unload ___

Модули по TAB подгружаются. Например $ module load codec <TAB>

Перезагрузить модуль, соответственно: $ module unload ____ && module load ____
 

core restart перезапустить астериск.
	core restart now				// Перезапуск службы сейчас
	core restart gracefully			// Новые вызовы запрещены, старые - дожидаемся конца, потом - рестарт.
	core restart when convenient	// Новые вызовы разрешены, старые - не прекращаются. Т.е. ждать того момента, когда люди не перестанут разговаривать, но при этом те, кто пытается новые звонки совершить - они смогут прозвониться.
	
core stop
		now
		gracefully
		when convenient
	
	


core reload обновить всю конфигурацию целостно. комманда очень мягкая и безопасная.

Что примечательно, во время выполнения комманды пользователи, ведущие разговор, изменений каких-либо не заметят, их разговор даже не прервётся, а вот приДля того, чтобы попасть в консоль мы пишем asterisk -rvvv
-r подключение к уже запущенному процессу
vvv (verbose) - логгирование. больше v = больше глубина логгирования 

После изменения конфигов: $ sip reload / $ dialplan reload / iax reload / something_module reload

Модули загружаются и выгружаются $ module load ___ , $ module unload ___

Модули по TAB подгружаются. Например $ module load codec <TAB>

Перезагрузить модуль, соответственно: $ module unload ____ && module load ____


$ core restart перезапустить астериск.
	
	core restart now				// Перезапуск службы сейчас
	
	core restart gracefully			// Новые вызовы запрещены, старые - дожидаемся конца, потом - рестарт.
	
	core restart when convenient	// Новые вызовы разрешены, старые - не прекращаются. Т.е. ждать того момента, когда люди не перестанут разговаривать, но при этом те, кто пытается новые звонки совершить - они смогут прозвониться. Система будет ждать момента, когда все наговорятся, и в какой-то момент, когда счётчик  активных разговоров будет равен нулю, ровно в этот момент система сделает либо остановку либо перезапуск .
	
	
		Если в какой-то момент времени вам захотелось отменить это действие [действие рестарта или действие выключения stop] -- существует комманда 
		$ core abort restart(shutdown)	
		
		
	
core stop
		now
		gracefully
		when convenient
	
	


core reload обновить всю конфигурацию целостно. комманда очень мягкая и безопасная.

Что примечательно, во время выполнения комманды пользователи, ведущие разговор, изменений каких-либо не заметят, их разговор даже не прервётся, а вот при следующем звонке обновлённая конфигурация уже даст о себе знать. 


core show uptime


core set verbose 1000	// аналог того, что при входе использовалось бы vvv тыща раз. Получается, что можно из консоли уровень verbose поднимать.


core show translations	// Доступные астериску кодеки и время транскодирования . Для того, чтобы понимать, является-ли этот кодек высоконагрузочным или низконагрузочным. Понимать, будет ли то или иное транскодирование сложным для сервера.


core show codecs	// Просто выводит список всех кодекод.

cire show channels показывает активные КАНАЛЫ ~~разговоры~~ на сервере. Вместе с тем, оно выводит количество активных разговоров, и так же стату того, сколько всего было обработано звонков

![Imgur](https://imgur.com/9dV8VdM.png)
Пример того, как 1 разговор занимает два канала.

Канал формируется между сервером и телефонным аппаратом.

В режиме конференции может быть мноджество каналов и 1 разговор



**SIP**


**IAX2**

iax reload

iax show peers

iax show peer 101

iax show peer flagmantelecom

iax show settings

iax show users

iax set debug on

iax set debug ip 192.168.1.1

iax set debug peer 101

iax set debug off

**RTP**

rtp set debug on

rtp set debug ip 192.168.1.1

rtp set debug off

**Dial Plan**

dialplan reload

dialplan show

dialplan show from-internal

dialplan show 101@from-internal

**Работа с log-файлами**

сыплет сюда /var/log/asterisk/messages

софт tailf / cat / grep

полезно: $ tailf /var/log/asterisk/full | grep Dial




## Dial Plan 

Номерной план.

Набор правил Asterisk по которым происходит логическая обработка всех вызовов.

Cердце самого астериска, логическое ядро, которое управляет всеми проходящими через астериск вызовами 

Текстовый файл, в котором прописываем на языке программирования определенные комманды.

Сам DialPlan структурно состоит из контекстов.
	Контексты - это изолированные области, сегменты, в которые помещаются экстетшены - добавочные номера. Т.е набрав который, происходит выполнение каких-то операций
	
	Контексты - это самая важная часть диалплана и самая важная часть Asterisk. 
	Контекст - это некий набор правил, который вы приписываете какому-нибудь абоненту. 
	
	Когда мы создаем некого сип-абонента, мы прописываем в нём ряд параметров: тип устройства, пароль, номер, т.д. **и среди этих параметров был параметр контекст**
	
	Когда абонент, которого вы создали совершает какой-то звонок, то астериск, чтобы этот звонок обработать обращается к контексту, который у этого абонента указан, и уже в этом контексте астериск ищет есть ли соответсвие набранного номера какому-то номеру, который в этом контексте содержится 
	
	Например, контекст from internal
	
	```
	[from internal]
	exten => 101,sgfldjkhfgdskhfgsd
	exten => 102,dfkjghsdklhkfg
	exten => 999,sdfkjghdskfjgh
	exten => 911,dsfkjghsdkjghsd
	exten => _XXXXXXXX, sdkgjhsdfkghdsg
	```
	
	Контексты: смысл. [функциональность]
	
	* Разделение абонентов по привилегиям
		абоненты, например, делятся по отделам организации. чтобы абоненты не совершали того, что им не нужно
	* Маршрутизация вызовов
		на меню, на сотрудников, на отделы 
	* IVR Интерактивное голосовое меню
		совершенно произвольные логики, совершенно произвольные озвучки, произвольное количество уровней. Некоторые специально делают здоровенные сложные меню, чтобы отсеивать народ. -- делать нужно нормально. компактно. юзабельно.
	* ДВО - Дополнительные Виды Обслуживания
	* Авторизация
		позволяет при совершении исходящего звонка затребовать у абонента пинкод. При accepted - диалплан выполняется дальше. 
	* Виртуальная АТС
		возможность виртуализации на уровне диалплана. Представим, что мы поставили сервер астериска и к этому серверу должны подключаться несколько организаций, и мы несмотря на то, что эти организации разные хотим сделать так, чтобы в них могли использоваться одинаковые внутренние телефоные номера. Например . Ну т.е. технически мы не способны сделать двух sip-абонентов с номером 101, чтобы они не конфликтовали, а юзая контекст мы создадим например абонента 101-001 и абонента 101-002 , где -001 -002 - будут контексты организаций. 001 - например ООО "АЛЬФА", 002 - ООО "ОМЕГА"
	* Дневной/ночной режим работы
		как правило рабочее\нерабочее время, но количество временных интервалов может быть произвольным. существуют команды, которые способны проверять принадлежит время определенному диапазану или нет. [if then esle ] 
		
		например, компания работает с 10 до 19, но захотела обрабатывать звонки которые поступают в промежуток с 19:00 - 20:00. т.е. выделяем этот период и маршрутизируем звонки не на офисные ip-телефоны например, а на мобильные телефоны дежурных менеджеров, которые данные звонки будут обрабатывать.
	* Исполнение системных команд Linux
		можем создать экстеншн, позвонив на которые астериск выполнит какую-либо линуксовую комманду. Ну и надо про права процесса помнить, от кого он там запущен, что он может, ограниченный пользователь или рут etc
	* Обратный вызов (CallBack)
		возможность, которая предполагает, что либо абонент звонил и недождался ответа оператора -- система сама ему перезванивает и связывает со свободным оператором; либо это функция, когда вы звоните в офис, система сбрасывает звонок и сама вам перезванивает. 
	* Безопасность, защита от взломов
	

Контекст задаётся исходя из того, из какой линии этот звонок войдёт.

Контекст устройства прописывается там же, где лежит сама конфигурация устройства.

В каждом  из конфигурационныз файлов, в том месте где создаётся транк, в том месте где создаётся dahdi, в том месте где создаётся extension -- ТАМ, вместе с остальными параметрами прописывается поле контекст. И этот параметр контекста у абонента может быть только один.


**При попытке абонента совершить звонок, астериск открывает контекст пользователя** - и если его нет, то астериск сразу же этот звонок отрубит. пошлёт телефону команду разрушения сессии.

Сам DialPlan - это просто текстовый файл, который расположен по адресу /etc/asterisk/extensions.conf 


Структурно это:
```
[general]	// для каких-то глобальных параметров
.

[globals]
..

[context_buch]
	exten => 123,1,sgfldjkhfgdskhfgsd
	exten => 123,2,dfkjghsdklhkfg
	exten => 123,3,sdfkjghdskfjgh
	
	exten => 134,1,dsfkjghsdkjghsd
	exten => 134,2,sdkgjhsdfkghdsg
	exten => 134,3,sdkgjhsdfkghdsg


[context_it_otdel]
	exten => 123,1,sgfldjkhfgdskhfgsd
	exten => 123,2,dfkjghsdklhkfg
	
```

В данном случае у нас у context_buch два экстеншна - это 123 и 134, и каждый из этих экстеншнов состоит из определенного количества шагов. шаг может быть один, может быть много.

т.о., синтаксис следующий:

**exten =>123,2,Playback(hello-world)**

**exten** - ключевое слово					// В варианте упрощённого синтаксиса - same.

**123** - добавочный номер

**2** - приоритет 							// Шаги выполняются друг за другом, в порядке приоритета. Вместо явного номера шага можно писать 'n', что подразумевает выполнение шага походу.

**Playback** - приложение(функция)			// Писать функцию без "()" допустимо тогда, когда нет параметров.

**hello-world** - параметр приложения

т.е., чтобы выполнилось Playback(hello-world) - нужно было набрать 123


альтернативный синтаксис (упрощённый)
```
exten => 999,1,Answer()
same => n,Playback(system-shutdown)
same => n,System(shutdown -h now)
same => n,Hangup()
```





## Приложения DialPlan


Каждое приложение выполняет определенное действие над текущим каналом.

В один момент времени выполняется только одно приложение.

* Answer()
Answer - ответ в канал. При выполнении функции происходит открытие RTP-сессии. [ т.е между вашим телефоном и сервером образуется голосовой канал, внутрь которого уже можно помещать какие-то данные ] -- на примере дампов можно увидеть разницу в обработке разговоров, в которых открыт голосовой канал и в котором не был открыт голосовой канал. 

* Progress()	! Поддерживается не всеми операторами связи. 2/3 поддерживают.
 Progress - установка в канал <<предответного состояния>>. В этом состоянии от сервера к телефону (в т.ч. к внешнему) может идти однонаправленный голосовой поток, за который не будут списываться деньги со звонящего абонента. (например музыка вместо гудков)

> exten => 1112233,1,Progress()
> same => n,Playback(hello-world,no-answer)

Смысл в том, что можно отвечать с помощью этой функции, там где это уместно.

* Hangup()
Hangup - завершение вызова. Действие противоположное Answer. Канал голосовой и сигнализационный разрушаются. Как правило, Hangup используется в конце экстеншена. Есть его не указываться, вызов всё равно завершится стандартный Hangup-ом.

В качестве параметра можно передавать код завершения для уведомления другой стороны о причине разрыва. Код корректного завершения - цифра 16.


* Echo()
Echo - **Применяется для проверки связи.** Разворачивает голосовой поток, в следствии чего звонящий слышит свой собственный голос с минимальной задержкой. Для работы, перед Echo() используется Answer()
```
exten => 999,1,Answer()
same => n,Echo()
same => n,Hangup()
```

* Milliwatt()
Miliwatt - **Применяется для проверки связи.** Генерирует сигнал частота 1КГц. Имеет смысл использовать для проверки на корректность передачи трафика и QoS
```
exten => 999,1,Answer
same => n,Milliwatt()
same => n,Hangup
```

* MorseCode()
Morsecode - функция корвертирует заданные символы в последовательности звуков азбуки Морзе.
```
exten => 999,1,Answer
same => n,MorseCode(ASTERISK)
same => n,Hangup()
```

* System()
System - Выполняется системная команда в пространстве команд Linux. Брать в расчёт права и привелегии данные процессу Asterisk. (от рута астериск и rm -rf) 

```
exten => 999,1,System(ping ya.ru -c 5 > /root/ping.txt)
```

* PlayBack()
PlayBack - вопроизводит заданный файл. По умолчанию берётся домашняя директория для системных звуков Астериск[Playback(Hello)]. Указывать файл нужно без расширения. -- хм, система сама выберет оптимальный формат - _в зависимости от кодека, с которого звонит абонент_

чекнуть каким форматом воспользуется астериск просто - смотрим трудозатраты на конвертацию из одного кодека в другой по таблице core show translations - Астериск выберет лучшее.

Параметры: **Noanswer** - приложение не будет отвечать в канал. Потому как Playback содержит в себе этот самый Answer. Это позволит воспроизвести сообщение без начала тарификации; **Skip** - пропустит Playback, если ранее не было ответа в канал (Answer)
```
exten => 999,1,Answer()
same => n,Playback(/root/hello)
same => n,Hangup()
```

* Record()
Record - Производит запись реичи в файл. Указывается имя файла с расширением. Что запись завершить жмакается решётка.
```
exten => 999,1,Answer()
same => n,Record(/root/hello.wav)
same => n,Playback(/root/hello)
same => n,Hangup()
```

* Wait()
Wait - Вводит программную задержку перед переходом на следующий шаг выполнения.
```
exten => 999,1,Answer
same => n,Wait
same => n,Playback(/root/hello)
same => n,Wait(3)
same => n,Hangup()
```

* Waitexten()
Waitexten - Вводится задержка как и в Wait, но позволяется вводить цифры. Введённые цифры будут использоваться для перехода на другой экстеншн. Обязательно пользовать перед вызовом функцию Answer .
```
exten => 999,1,Answer()
same => n,Playback(/root/vvedite-nomer)
same => n,Waitexten(10)
same => n.Hangup()
exten => 10,1,Playback(/root/nomer)
same => n,Milliwatt()
same => n,Hangup()
```


* SayDigits()
SayDigits - Воспроизводит цифры, составляющие заданное цисло <<Два>> <<Семь>> <<Восемь>>. Требует для пользования Answer.
```
exten -> 999,1,Answer()
same => n,SayDigits(278)
same => n,Hangup()
```

* SayNumber
SayNumber - воспроизводит число целиком. <<Двести семьдесят восемь>> Требует для пользования Answer.

```
exten => 999,1,Answer()
same => n,SayNumber(278)
same => n,Hangup()
```

* NoOp 
NoOp - No Operations - не выполняет никаких реальных действий, кроме отображения данного шага выполнения в консоли. **Назначение - отладка, таким образом можно вносить комментарии в а диалплан**
```
exten =>999,1,Answer()
same => n,NoOp(==SayNumber App==)
same => n,SayNumber(278)
same => n,NoOp(==SayDigits App==)
same => n,SayDigits(278)
same => n,Hangup()
```
* Verbose()
Verbose - используется для логгирования событий диалплана. В целом похожа на NoOp, но имеет возможность указания <<важности>>.
```
exten => 999,1,Answer()
same => n,Verbose(5,CallerId = ${CALLERID})
same => n,Hangup()
```
 В чём смысл: вот мы указали в примере выше 5. Это значит, что если мы подсоединимся к астериску с уровнем вербос 4 [-rvvvv] -- то это сообщение (с уровнем 5) не попадёт в наш вывод.

* Set()
Set - создаёт переменную, устанавливает новое значение в заданную переменную.
```
exten => 999,1,Answer()
same => n,Set(FILE=/root/file)
same => n,Playback(${FILE})
same => n,Hangup()
```

* Dial() 
Dial - выполняет коммутацию двух новых каналов. Первый канал - уже установлен при звонке на экстеншен, второй канал - задан в параметре к Dial

```exten => 123,1,Dial(SIP/123)```
```exten => 123,1,Dial(SIP/msm/121)```

Каналы могут быть локальными - и тогда мы просто используем синтаксис SIP/номер, или же каналы могут быть связаны транками и тогда синтаксис: SIP/транк/номер (технология/транк/номер,время,параметры)
```
[from-internal]
exten => 123,1,Dial(SIP/123,10,m)  // вызывать абонента мы будем 10 секунд, если он трубку не снимет то мы перейдём к следующему шагу
same => n,Hangup()

exten => 1234567,1,Dial(SIP/msm/84959898533,100)
same => n,Hangup()
```
```
Dial параметры:
m - Music On Hold.
m(class) - Music On Hold c классом class   // каждому абоненту можно свою музыку отдавать, различие по классам.
t,T - возможность выполнения перевода вызова вызывающей или вызываемой стороной.
L( x[:y][:z]) - ограничение продолжительности вызовов   // L(3600000:300000:60000)  -- звонящий услышит стандартное предупреждение о том, что скоро разговор будет завершён за 5 минут(300000мс) до конца длительности разговора(1час,3600000мс). Предупреждение будет повторятся с периодичностью в 1 минуту (60000мс)
r - генерация КПВ(гудков) вызывающей стороне
```


---

; прикольно
$ dialplan show from-e1
