# Eduard Titkov WorkArea 

## Гарольд-Lite. Входящий И Исходящий Роутинг.

## Гарольд-Lite. Правила по времени, очереди звонков, группы вызовов, уведомление о пропущенных звонках, архивация конфигурации.

### Очередь и группа вызова

Распространненая задача, когда входящий звонок должен маршрутизироваться на группу добавочных номеров.

**Групповой телефон (Группа вызова)**

Группа вызова - это своеобразный групповой телефон, который в состоянии принять вызов, если хотя бы один член группы не находится в разговоре. Групповой телефон будет занят, если все члены группы находятся в разговоре. Если в результате любой из стратегий никто не взял трубку, звонок уйдёт по ветке неответа.


**Очередь**

Главным и принципиальным отличием от группы вызовов является тот факт, что даже при занятности всех операторов, вызовы, поступающие в очередь будут находиться в ней до тех пор, пока не ответит любой из операторов или не истечет глобальный таймер этой очереди.		Звонящий будет удерживаться в очереди, ему будет проигрываться мелодия ожидания, и будет выполняться постоянный поиск доступного оператора.

А в группе вызова, в ситуации когда нет доступных операторов (все находятся в разговоре или никто за фиксированное время не взял трубку, сразу же произойдет перенаправление по неответу, в результате звонок тут же покинет группу вызова. -- никакого удержания звонка, в отличии от очереди, группа вызова не выполняет.

Одной из самых популярных стратегий является выбор того оператора (из свободных), который на момент распределения вызова меньше всех разговаривал.

Важным преимуществом очереди перед группой вызова является возможность контроля за качеством работы контакт-центра благодаря фиксации множества статистических данных.

Стастистика нагрузки на операторов ведется в рамках текущего дня, и по его завершению сбрасывается. Такими образом, контакт-центр добивается равномерной нагрузки на всех операторов в рамках рабочего дня.


функционал и стратегии

* позиция в очереди, озвучка позиции в очереди, 

* заказ обратного звонка, если позиция в очереди какая-то далекая [при согласии: связь прерывается, но позиция в очереди сохраняется. и когда до такого клиента доходит очередь - атс сама его прозванивает и соединяет с освободившимся оператором.]

* автоматический обратный звонок, если клиент просто сбросил связь. -- клиент уставший ждать и просто положивший трубку называется упущенным клиентом, и это механизм его 'возврата'


---

**Задание 1 на Vanilla**
```
На Vanilla Asterisk: 

Входящий роутинг: 

Взять WAV-файл 1 с озвучкой от диктора, нарезать с помощью Audacity на файлы, подходящие для Asterisk 

Настроить IVR из двух уровней. 

1 уровень: 
Приветствие 
• Нажатие цифры 1 – звонит 101 
• Нажатие цифры 2 – звонит 102 
• Нажатие цифры 3 – звонок идет на 201 через IAX2 
• Нажатие цифры 4 – IVR2 2 уровень: 

2 уровень: 
Нажатие цифры 1 – включается эхо-тест 
При любом неправильном нажатии должно запускаться уведомление «Ошибка набора» и IVR запускается заново.

**Для умных: сделать счетчик ошибочных наборов и после 3-го неправильного набора воспроизводить фразу «Это была последняя ошибка» и класть трубку. 

Исходящий роутинг: 
• 1XX->2XX 
• 1XX ->8495XXXXXXX через MSM 
• 1XX -> 89XXXXXXXXX через Задарма 
• 1XX -> 810X. – «исходящие на международные линии запрещены». При этом отправлять SMS-ку и E-mail письмо себе (т.е. администратору) 
• 1XX — > 9X. – через FreePBX c отрезанием 9-ки 
```

**Задание 2 на Vanilla**
```
На Asterisk Vanilla: 

Правила по времени 

Сделать так, чтобы с 17 вечера до 10 утра озвучивалось сообщение: «Мы не работаем» и записывалось сообщение, которое будет пересылаться на твою почту. 


Очереди звонков 
Создай из тех абонентов что у тебя есть не менее 3-х очередей с разными стратегиями. 
	Распиши, в каком случае какую очередь использовать целесообразнее всего.

Группы вызовов 
Создай из тех абонентов что у тебя есть не менее 3-х групп вызовов с разными стратегиями. 
	Распиши, в каком случае какую очередь использовать целесообразнее всего. 



	
Уведомление о пропущенных звонках 
Сделать так, чтобы при пропущенном звонке тебе уходила SMS-ка с номером звонящего 



Архивация конфигурации **Для умных 
Настроить cron и написать скрипт, который будет папку с конфигурацией Asterisk архивировать раз в час и отправлять на твою почту. 
```

**Задание 1 на FreePBX**
```
На FreePBX: 

Входящий роутинг: 

Взять WAV-файл 2 с озвучкой от диктора, нарезать с помощью Audacity на файлы, подходящие для Asterisk 


Настроить IVR из двух уровней. 

1 уровень: 
Приветствие 
• Нажатие цифры 1 – звонит 201 
• Нажатие цифры 2 – звонит 202 
• Нажатие цифры 3 – звонок идет на 101 через IAX2 
• Нажатие цифры 4 – IVR2 2 уровень: 

2 уровень: 
Нажатие цифры 1 – включается эхо-тест 
При любом неправильном нажатии должно запускаться уведомление «Ошибка набора» и IVR запускается заново. 

**Для всех: сделать счетчик ошибочных наборов и после 3-го неправильного набора воспроизводить фразу «Это была последняя ошибка» и класть трубку. 

Исходящий роутинг: 
• 2XX->1XX 
• 2XX ->8495XXXXXXX через MSM 
• 2XX -> 89XXXXXXXXX через Задарма 
• 2XX -> 810X. – «исходящие на международные линии запрещены». При этом отправлять SMS-ку и E-mail письмо себе (т.е. администратору) 
• 2XX — > 9X. – через Asterisk c отрезанием 9-ки. К каждому пункту задачи необходимо приложить артефакт!
```



**Задание 2 на FreePBX**
```
На FreePBX: 

Правила по времени 
Сделать так, чтобы с 17 вечера до 10 утра озвучивалось сообщение: «Мы не работаем» и записывалось сообщение, которое будет пересылаться на твою почту. 



Очереди звонков 
Создай из тех абонентов что у тебя есть не менее 3-х очередей с разными стратегиями. 
	Распиши, в каком случае какую очередь использовать целесообразнее всего. 
	
Группы вызовов 
Создай из тех абонентов что у тебя есть не менее 3-х групп вызовов с разными стратегиями. 
	Распиши, в каком случае какую очередь использовать целесообразнее всего. 
	
	
	
Уведомление о пропущенных звонках 
Сделать так, чтобы при пропущенном звонке тебе уходил E-Mail со всей инфой 

Архивация конфигурации **Для всех 
Настроить через веб-интерфейс функционал архивации и сделать так, чтобы конфигурация архивировалась с помощью SSH на сервер Asterisk Vanilla. 


По каждому пункту необходимо прикрепить артефакт!
```






**Решение 1 на Vanilla**

Таким образом выглядит sip.conf
```
[root@localhost asterisk]# vim sip.conf

[general]
context=public                  ; Default context for incoming calls. Defaults to 'default'

;;;;;;;;;;;;;;;;;;;;;;;;;
language=ru

bindport=5060

callcounter=yes ; chtobi rabotal callcounter po staroy sheme call-limit





register => 74993809053:yn4tD0td@1016.voxlink.ru/74993809053



[voxlink-trunk]

host=1016.voxlink.ru
; fromdomain=

defaultuser=74993809053
fromuser=74993809053
secret=yn4tD0td

type=friend
context=from-trunk

qualify=yes

disallow=all
allow=alaw,ulaw

directmedia=no
directrtpsetup=no

; не требовать аутентификации входящих сообщений INVITE
insecure=invite

; игнорировать номер порта с которого пришла аутентификация
insecure=port



[MSM]

;;;;;;;;; eto zaglushka, razumeetsa

host=1016.voxlink.ru

defaultuser=74993809053
fromuser=74993809053
secret=yn4tD0td

type=friend
context=from-trunk

qualify=yes

disallow=all
allow=alaw,ulaw

directmedia=no
directrtpsetup=no

; не требовать аутентификации входящих сообщений INVITE
insecure=invite

; игнорировать номер порта с которого пришла аутентификация
insecure=port



[Zadarma]

;;;;;;;;; eto zaglushka, razumeetsa

host=1016.voxlink.ru

defaultuser=74993809053
fromuser=74993809053
secret=yn4tD0td

type=friend
context=from-trunk

qualify=yes

disallow=all
allow=alaw,ulaw

directmedia=no
directrtpsetup=no

; не требовать аутентификации входящих сообщений INVITE
insecure=invite

; игнорировать номер порта с которого пришла аутентификация
insecure=port
```


Экстеншены:
```
[root@localhost asterisk]# vim extensions.conf

[general]

[globals]

[from-internal]

exten=>999,1,GoTo(IVR_company_tree,s,1);





[from-trunk]

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;; ISHODYASHAYA MARSHRUTIZACIYA
;1XX -> 2XX
exten => _1XX,1,Dial(SIP/2${EXTEN:1})

; 1XX -> 8495XXXXXXX cherez MSM |||| na osnovanii CALLER-ID
exten => _8495XXXXXXX/_1XX,1,Dial(SIP/MSM/${EXTEN},10)

; 1XX -> 89XXXXXXXXX cherez Zadarma |||| na osnovanii CALLER-ID
exten => _89XXXXXXXXX/_1XX,1,Dial(SIP/Zadarma/${EXTEN},10)

; 1XX -> 810X. "ishodyashie na mezgdunarodnie linii zapresheni". pri etom sms+email sebe (administratoru)
exten => _810X./_1XX,1,Playback(/home/ulaw/from-trunk/810-block)
exten => _810X./_1XX,2,Wait(2)
exten => _810X./_1XX,3,Hangup()
exten => _810X./_1XX,n,______________________sms
exten => _810X./_1XX,n,______________________ email

; 1XX - > 9X. cherez FreePBX s otrezaniem 9-ki
exten => 9X./_1XX,1,Dial(IAX2/vanilla-user-for-pbx/${EXTEN:1},90)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; sdelat' tak 4tobi s 17 ve4era do 10 utra
;       ozvuchivalos' soobshenie mi ne rabotaem,
;       zapisivalos' soobshenie (voicemail)
;       peresilalos na tvoyu pochtu
;
;; eto dolzhno bit pervim na vhode vsex incoming
; po maske-to ya ponimayu kak propisat, no kak sdelat' 4tobi v obhod maski ne hodili.
;
; pogodi, eto vhodyashaya marshrutizaciya, 
;
;
; t.e. eto mozhet bit vida 
;
;[from-trunk]
;
;
;
;exten => _X.,1,IfToGo()
;
;; v dannom slu4ae eto prokatit, no chto esli vmeste s etim na vhod prihodyat zvonki s drugih trunks, kotorie nuzhno perepravlyat' - togda nuzhno videlyat' bolee to4nuyu masku vnutrennix nomerov. -- davay srazu ee videlim _XXX
;
; a chto esli nuzhno perepravlyat' na takie-zhe vnutrennit nomera - s takoy ze maskoy, no na druguy ats? v drugom chasovom poyase? 
;
;
;
;
;
;
;
;
;
;
;
;


















[IVR_company_tree]
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;|IVR LEVEL 1|
exten => s,1,NoOp(IVR LEVEL 1);
exten => s,2,Set(ErrEnter1=0);

exten => s,3,Answer();
exten => s,4,Playback(/home/ulaw/privet);
exten => s,5,Background(/home/ulaw/IVR-zapis-1);
exten => s,n,WaitExten(7); nemnogo vremeni na osmislenie i vibor


;;;;
;;;;;;;
;;;;;;;;;;
exten => i,1,NoOp(NEVERNIY VVOD);
exten => i,n,Set(ErrEnter1=${ErrEnter1}+1);

exten => i,n,GoToIf($["${ErrEnter1}" = "3"]?true:false);

exten => i,n(false),Verbose(false)
exten => i,n,Playback(/home/ulaw/oshibka-nabora)
exten => i,n,GoTo(s,4)

exten => i,n(true),Playback(/home/ulaw/vi-samoe-slaboe-zveno-proshayte);
exten => i,n,Hangup();
;;;;;;;;;;
;;;;;;;
;;;;


exten => 1,1,Wait(1);
exten => 1,n,Dial(SIP/101,90);

exten => 2,1,Wait(1);
exten => 2,n,Dial(SIP/102,90);

exten => 3,1,Wait(1);
exten => 3,n,Dial(IAX2/vanilla-user-for-pbx/201,90);

exten => 4,1,NoOp(GoTo: IVR LEVEL 2);
exten => 4,n,GoTo(IVR_company_tree_lvl2,s,1);



[IVR_company_tree_lvl2]
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;|IVR LEVEL 2|
exten => s,1,NoOp(IVR LEVEL 2);
exten => s,2,Set(ErrEnter2=0);

exten => s,3,Background(/home/ulaw/IVR-zapis-2);
exten => s,n,WaitExten(7);


;;;;
;;;;;;;
;;;;;;;;;;
exten => i,1,NoOp(NEVERNIY VVOD);
exten => i,n,Set(ErrEnter2=${ErrorEnter2}+1);

exten => i,n,GoToIf($["${ErrEnter2}" = "3"]?true:false);

exten => i,n(false),Verbose(false);
exten => i,n,Playback(/home/ulaw/oshibka-nabora)
exten => i,n,GoTo(s,3)

exten => i,n(true),Playback(/home/ulaw/vi-samoe-slaboe-zveno-proshayte);
exten => i,n,Hangup();
;;;;;;;;;;
;;;;;;;
;;;;


exten => 1,1,Playback(demo-echotest);
exten => 1,n,Echo;
exten => 1,n,Playback(demo-echodone)
```

### ХВОСТЫ (что недоделано):

#### Хвосты Задание 1 на Vanilla


**ЕМЕЙЛ АДМИНИСТРАТОРУ** ( 2XX -> 810X. – «исходящие на международные линии запрещены». При этом отправлять SMS-ку и E-mail письмо себе (т.е. администратору) )
``` необходимо поднять posix-relay и привязать к нему учётку гугла ```
```
yum -y install postfix cyrus-sasl-plain mailx


```

**SMS АДМИНИСТРАТОРУ** ( 2XX -> 810X. – «исходящие на международные линии запрещены». При этом отправлять SMS-ку и E-mail письмо себе (т.е. администратору) )
``` зарегистрироваться на шлюзе получить у него API, заюзать её ```


**ПРОТЕСТИРОВАТЬ IVR** (Внутренняя маршрутизация по номеру 999)
``` убедиться что все окей ```



#### Хвосты Задание 2 на Vanilla
```
Сделать так, чтобы с 17 вечера до 10 утра озвучивалось сообщение: «Мы не работаем» и записывалось сообщение, которое будет пересылаться на твою почту. 

Уведомление о пропущенных звонках 
Сделать так, чтобы при пропущенном звонке тебе уходила SMS-ка с номером звонящего 

Очереди звонков 
Создай из тех абонентов что у тебя есть не менее 3-х очередей с разными стратегиями. 
	Распиши, в каком случае какую очередь использовать целесообразнее всего.

Группы вызовов 
Создай из тех абонентов что у тебя есть не менее 3-х групп вызовов с разными стратегиями. 
	Распиши, в каком случае какую очередь использовать целесообразнее всего. 
	
	
Архивация конфигурации **Для умных 
Настроить cron и написать скрипт, который будет папку с конфигурацией Asterisk архивировать раз в час и отправлять на твою почту. 
```

#### Хвосты Задание 1 на FreePBX

#### Хвосты Задание 2 на FreePBX



---



```
На FreePBX: 

Входящий роутинг: 

Взять WAV-файл 2 с озвучкой от диктора, нарезать с помощью Audacity на файлы, подходящие для Asterisk 


Настроить IVR из двух уровней. 

1 уровень: 
Приветствие 
• Нажатие цифры 1 – звонит 201 
• Нажатие цифры 2 – звонит 202 
• Нажатие цифры 3 – звонок идет на 101 через IAX2 
• Нажатие цифры 4 – IVR2 2 уровень: 

2 уровень: 
Нажатие цифры 1 – включается эхо-тест 
При любом неправильном нажатии должно запускаться уведомление «Ошибка набора» и IVR запускается заново. 

**Для всех: сделать счетчик ошибочных наборов и после 3-го неправильного набора воспроизводить фразу «Это была последняя ошибка» и класть трубку. 

Исходящий роутинг: 
• 2XX->1XX 
• 2XX ->8495XXXXXXX через MSM 
• 2XX -> 89XXXXXXXXX через Задарма 
• 2XX -> 810X. – «исходящие на международные линии запрещены». При этом отправлять SMS-ку и E-mail письмо себе (т.е. администратору) 
• 2XX — > 9X. – через Asterisk c отрезанием 9-ки. К каждому пункту задачи необходимо приложить артефакт!
```

